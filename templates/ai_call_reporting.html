{% extends "base.html" %}

{% block title %}AI Call Reporting - JalScan{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Sync Status Banner -->
    {% if sync_result %}
    <div class="alert alert-{{ 'success' if sync_result.synced > 0 else 'info' }} alert-dismissible fade show mb-4">
        <i class="bi bi-cloud-download"></i>
        {% if sync_result.synced > 0 %}
        <strong>Synced {{ sync_result.synced }} new records</strong> from external AI call agent!
        {% else %}
        No new records to sync. Total records: {{ sync_result.total or 0 }}
        {% endif %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <div class="row">
        <!-- Call Controls -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header" style="background: linear-gradient(135deg, #6f42c1, #8c68d6); color: white;">
                    <h5 class="mb-0"><i class="bi bi-telephone-fill"></i> Voice Call Reporting</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Voice call reports are automatically synced from the external AI call agent.
                    </p>

                    <div class="d-grid gap-2">
                        <a href="https://0ebcaa8c-6200-4348-ba81-59a81e4dde75-00-3b8ylx78kwy2o.sisko.replit.dev/data/live"
                            target="_blank" class="btn btn-primary">
                            <i class="bi bi-bar-chart-fill"></i> View Live Dashboard
                        </a>
                        <a href="https://0ebcaa8c-6200-4348-ba81-59a81e4dde75-00-3b8ylx78kwy2o.sisko.replit.dev"
                            target="_blank" class="btn btn-outline-primary">
                            <i class="bi bi-telephone-outbound"></i> Open AI Call Interface
                        </a>
                        <button class="btn btn-outline-secondary" onclick="syncData()">
                            <i class="bi bi-arrow-repeat"></i> Sync Now
                        </button>
                    </div>

                    <div id="syncStatus" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <i class="bi bi-hourglass-split"></i> <span id="syncStatusText">Syncing...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- How It Works -->
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> How Voice Reporting Works</h6>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li>Enter the field agent's phone number</li>
                        <li>Click "Initiate Call" to start the call</li>
                        <li>Agent receives call and speaks the water level report</li>
                        <li>AI transcribes and saves data to the database</li>
                        <li>Report appears in your dashboard automatically</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Voice Submissions -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-mic-fill"></i> Recent Voice Submissions</h5>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    {% if voice_submissions %}
                    <div class="list-group list-group-flush">
                        {% for submission in voice_submissions %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ submission.site.name if submission.site else 'Unknown Site' }}</strong>
                                    <br>
                                    <span class="badge bg-primary">{{ submission.water_level }}m</span>
                                    <small class="text-muted ms-2">
                                        {{ submission.timestamp.strftime('%Y-%m-%d %H:%M') }}
                                    </small>
                                </div>
                                <span class="badge bg-success">
                                    <i class="bi bi-mic"></i> Voice
                                </span>
                            </div>
                            {% if submission.notes %}
                            <small class="text-muted">{{ submission.notes }}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-mic-mute display-4"></i>
                        <p class="mt-2">No voice submissions yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-gear"></i> Voice System Configuration</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <span class="status-indicator bg-success me-2"
                                    style="width: 10px; height: 10px; border-radius: 50%; display: inline-block;"></span>
                                <span>Twilio Voice: Active</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <span class="status-indicator bg-success me-2"
                                    style="width: 10px; height: 10px; border-radius: 50%; display: inline-block;"></span>
                                <span>Speech Recognition: Active</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center">
                                <span class="status-indicator bg-success me-2"
                                    style="width: 10px; height: 10px; border-radius: 50%; display: inline-block;"></span>
                                <span>Database Sync: Active</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function syncData() {
        const statusDiv = document.getElementById('syncStatus');
        const statusText = document.getElementById('syncStatusText');

        statusDiv.style.display = 'block';
        statusText.textContent = 'Syncing data from external API...';

        try {
            const response = await fetch('/api/voice/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.synced > 0) {
                statusText.textContent = `Synced ${data.synced} new records! Reloading...`;
                setTimeout(() => location.reload(), 1500);
            } else if (data.error) {
                statusText.textContent = 'Error: ' + data.error;
            } else {
                statusText.textContent = `No new records. Total: ${data.total}`;
            }
        } catch (error) {
            statusText.textContent = 'Error: ' + error.message;
        }
    }
</script>
{% endblock %}