{% extends "base.html" %}

{% block title %}Flood Risk Dashboard - JalScan{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold text-primary mb-1">
                        <i class="bi bi-tsunami me-2"></i><span data-i18n="flood_risk_dashboard_title">Flood Risk
                            Dashboard</span>
                    </h2>
                    <p class="text-muted mb-0" data-i18n="flood_risk_dashboard_desc">AI-powered flood predictions for
                        all monitoring sites</p>
                </div>
                <button class="btn btn-primary" onclick="refreshAllPredictions()">
                    <i class="bi bi-arrow-clockwise me-1"></i><span data-i18n="refresh">Refresh</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Risk Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center">
                    <h3 class="mb-0" id="safe-count">-</h3>
                    <small data-i18n="safe">SAFE</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body text-center">
                    <h3 class="mb-0" id="caution-count">-</h3>
                    <small data-i18n="caution">CAUTION</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-danger text-white h-100">
                <div class="card-body text-center">
                    <h3 class="mb-0" id="flood-count">-</h3>
                    <small data-i18n="flood_risk_label">FLOOD RISK</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-dark text-white h-100">
                <div class="card-body text-center">
                    <h3 class="mb-0" id="flash-count">-</h3>
                    <small data-i18n="flash_flood">FLASH FLOOD</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Site Risk Cards -->
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i><span data-i18n="sites_risk_status">Sites Risk
                            Status</span></h5>
                </div>
                <div class="card-body">
                    <div id="sites-container" class="row">
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Loading predictions...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Site Details Modal -->
<div class="modal fade" id="siteDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" id="modal-header-bg">
                <h5 class="modal-title" id="modal-site-name">Site Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div id="modal-risk-badge" class="badge fs-5 px-3 py-2 mb-2"></div>
                    <div class="display-4 fw-bold" id="modal-risk-score">--%</div>
                    <small class="text-muted">Confidence Score</small>
                </div>
                <div class="card bg-light">
                    <div class="card-body">
                        <h6><i class="bi bi-lightbulb me-2"></i>AI Explanations</h6>
                        <ul class="mb-0" id="modal-explanations"></ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="modal-view-site" class="btn btn-primary">
                    <i class="bi bi-graph-up me-1"></i>View History
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .site-card {
        transition: transform 0.2s;
        cursor: pointer;
    }

    .site-card:hover {
        transform: translateY(-2px);
    }

    .risk-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .chat-message {
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .chat-user {
        background: #e3f2fd;
        margin-left: 20%;
    }

    .chat-bot {
        background: #f5f5f5;
        margin-right: 20%;
    }
</style>

<script>
    // Load predictions on page load
    document.addEventListener('DOMContentLoaded', function () {
        loadAllSitePredictions();
    });

    function loadAllSitePredictions() {
        fetch('/api/flood-risk/all-sites')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderSiteCards(data.sites);
                    updateCounters(data.sites);
                } else {
                    showError('Failed to load predictions');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Network error loading predictions');
            });
    }

    function renderSiteCards(sites) {
        const container = document.getElementById('sites-container');

        if (!sites || sites.length === 0) {
            container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">No monitoring sites found</p>
            </div>
        `;
            return;
        }

        let html = '';
        sites.forEach(site => {
            const riskClass = getRiskClass(site.risk_category);
            const riskIcon = getRiskIcon(site.risk_category);

            html += `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card site-card border-${riskClass}" onclick="showSiteDetails(${site.monitoring_site_id})">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${site.site_name || 'Site ' + site.monitoring_site_id}</h6>
                                <span class="badge bg-${riskClass} risk-badge">
                                    <i class="bi ${riskIcon} me-1"></i>${site.risk_category || 'UNKNOWN'}
                                </span>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">${(site.risk_score * 100).toFixed(0)}%</div>
                                <small class="text-muted">confidence</small>
                            </div>
                        </div>
                        ${site.explanations && site.explanations.length > 0 ?
                    `<small class="text-muted d-block mt-2">${site.explanations[0]}</small>` : ''}
                    </div>
                </div>
            </div>
        `;
        });

        container.innerHTML = html;
    }

    function updateCounters(sites) {
        const counts = { SAFE: 0, CAUTION: 0, FLOOD_RISK: 0, FLASH_FLOOD_RISK: 0 };
        sites.forEach(site => {
            if (counts.hasOwnProperty(site.risk_category)) {
                counts[site.risk_category]++;
            }
        });

        document.getElementById('safe-count').textContent = counts.SAFE;
        document.getElementById('caution-count').textContent = counts.CAUTION;
        document.getElementById('flood-count').textContent = counts.FLOOD_RISK;
        document.getElementById('flash-count').textContent = counts.FLASH_FLOOD_RISK;
    }

    function getRiskClass(category) {
        switch (category) {
            case 'SAFE': return 'success';
            case 'CAUTION': return 'warning';
            case 'FLOOD_RISK': return 'danger';
            case 'FLASH_FLOOD_RISK': return 'dark';
            default: return 'secondary';
        }
    }

    function getRiskIcon(category) {
        switch (category) {
            case 'SAFE': return 'bi-check-circle';
            case 'CAUTION': return 'bi-exclamation-triangle';
            case 'FLOOD_RISK': return 'bi-exclamation-octagon';
            case 'FLASH_FLOOD_RISK': return 'bi-lightning';
            default: return 'bi-question-circle';
        }
    }

    function refreshAllPredictions() {
        document.getElementById('sites-container').innerHTML = `
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-2">Refreshing predictions...</p>
        </div>
    `;
        loadAllSitePredictions();
    }

    function showSiteDetails(siteId) {
        fetch(`/api/flood-risk/site/${siteId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate modal
                    const riskClass = getRiskClass(data.risk_category);
                    const riskIcon = getRiskIcon(data.risk_category);

                    document.getElementById('modal-site-name').textContent = data.site_name;
                    document.getElementById('modal-header-bg').className = `modal-header bg-${riskClass} text-white`;
                    document.getElementById('modal-risk-badge').innerHTML = `<i class="bi ${riskIcon} me-1"></i>${data.risk_category}`;
                    document.getElementById('modal-risk-badge').className = `badge bg-${riskClass} fs-5 px-3 py-2 mb-2`;
                    document.getElementById('modal-risk-score').textContent = `${(data.risk_score * 100).toFixed(0)}%`;

                    // Build explanations list
                    const expList = document.getElementById('modal-explanations');
                    expList.innerHTML = data.explanations.map(exp => `<li>${exp}</li>`).join('');

                    // Set view site link  
                    document.getElementById('modal-view-site').href = `/river-memory?site=${siteId}`;

                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('siteDetailsModal'));
                    modal.show();
                }
            });
    }

    function showError(message) {
        document.getElementById('sites-container').innerHTML = `
        <div class="col-12 text-center py-5">
            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2">${message}</p>
            <button class="btn btn-outline-primary btn-sm" onclick="refreshAllPredictions()">Try Again</button>
        </div>
    `;
    }
</script>
{% endblock %}