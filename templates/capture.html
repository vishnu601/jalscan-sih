{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">Capture Reading - {{ site.name }}</h4>
            </div>
            <div class="card-body">
                <!-- Location Verification Section -->
                <div class="mb-4">
                    <h5>Location Verification</h5>
                    <div id="location-status" class="alert alert-warning">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>Checking your location...</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Site Coordinates:</strong><br>
                                {{ "%.6f"|format(site.latitude) }}, {{ "%.6f"|format(site.longitude) }}</p>
                            <p><strong>Site QR Code:</strong><br>
                                <code>{{ site.qr_code }}</code>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Your Coordinates:</strong><br>
                                <span id="user-coords">Waiting for GPS...</span>
                            </p>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted" id="distance-info"></small>
                    </div>
                </div>

                <!-- QR Code Validation Section -->
                <div class="mb-4" id="qr-section">
                    <h5>QR Code Validation <small class="text-muted">(Alternative to GPS)</small></h5>
                    <div class="alert alert-info">
                        <small>If GPS is unavailable or inaccurate, scan the QR code installed at the monitoring
                            site.</small>
                    </div>
                    <div class="d-grid gap-2">
                        <button id="scan-qr-btn" class="btn btn-outline-primary">
                            <i class="bi bi-qr-code-scan"></i> Scan QR Code
                        </button>
                    </div>
                    <div id="qr-scanner" style="display: none;" class="mt-3">
                        <div id="qr-reader"
                            style="width: 100%; height: 300px; border: 2px dashed #ccc; background: #f8f9fa;"></div>
                        <div class="mt-2 text-center">
                            <small class="text-muted">Point your camera at the QR code</small>
                        </div>
                        <div class="mt-2 text-center">
                            <button id="stop-qr-btn" class="btn btn-secondary btn-sm">
                                <i class="bi bi-x-circle"></i> Stop Scanner
                            </button>
                        </div>
                    </div>
                    <div id="qr-result" class="alert mt-2" style="display: none;"></div>

                    <!-- Manual QR Code Entry Fallback -->
                    <div id="manual-qr-entry" class="mt-3" style="display: none;">
                        <div class="alert alert-warning">
                            <small>QR scanner not available. You can manually enter the QR code below.</small>
                        </div>
                        <div class="mb-3">
                            <label for="manual-qr-input" class="form-label">Enter QR Code:</label>
                            <input type="text" class="form-control" id="manual-qr-input"
                                placeholder="Enter the QR code from the site (e.g., {{ site.qr_code }})">
                        </div>
                        <button id="submit-manual-qr" class="btn btn-primary btn-sm">
                            <i class="bi bi-check-circle"></i> Verify QR Code
                        </button>
                    </div>
                </div>

                <!-- Camera Selection -->
                <div class="mb-3" id="camera-selection" style="display: none;">
                    <label class="form-label">Camera:</label>
                    <select id="camera-select" class="form-select">
                        <option value="">Select Camera...</option>
                    </select>
                </div>

                <!-- Photo Capture Section -->
                <div class="mb-4" id="photo-section">
                    <h5>Photo Capture</h5>
                    <div class="mb-3">
                        <div id="camera-container">
                            <video id="video" width="100%" height="300"
                                style="border: 1px solid #ccc; display: none; background: black;"></video>
                            <div id="camera-error" class="alert alert-danger" style="display: none;">
                                <strong>Camera Error:</strong> <span id="error-message"></span>
                            </div>
                        </div>
                        <canvas id="canvas" style="display: none;"></canvas>
                        <div id="photo-preview" style="display: none;">
                            <img id="preview-img" style="max-width: 100%; border: 1px solid #ccc; border-radius: 8px;">
                            <div class="mt-2 text-center">
                                <small class="text-muted">Photo preview - Click retake if needed</small>
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button id="start-camera-btn" class="btn btn-primary" disabled>
                            <i class="bi bi-camera"></i> Start Camera
                        </button>
                        <button id="capture-btn" class="btn btn-success" style="display: none;">
                            <i class="bi bi-camera-fill"></i> Capture Photo
                        </button>
                        <button id="retake-btn" class="btn btn-warning" style="display: none;">
                            <i class="bi bi-arrow-clockwise"></i> Retake Photo
                        </button>
                        <button id="switch-camera-btn" class="btn btn-info" style="display: none;">
                            <i class="bi bi-arrow-left-right"></i> Switch Camera
                        </button>
                    </div>
                </div>

                <!-- Water Level Input Section -->
                <div class="mb-4" id="input-section">
                    <h5>Water Level Measurement</h5>

                    <div class="mb-3">
                        <label class="form-label">Water Level Input Method</label>
                        <button type="button" id="scan-gauge-btn" class="btn btn-outline-primary w-100 mb-2">
                            Scan from Gauge
                        </button>
                        <div class="text-center text-muted small mb-2">Or enter manually below</div>
                    </div>

                    <form id="reading-form">
                        <input type="hidden" name="site_id" value="{{ site.id }}">
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        <input type="hidden" id="verification_method" name="verification_method" value="gps">
                        <input type="hidden" id="qr_code_scanned" name="qr_code_scanned">

                        <!-- AI Analysis Result -->
                        <div id="ai-analysis-card" class="card mb-3 d-none">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-robot"></i> AI Analysis</h5>
                                <div id="ai-loading" class="d-none">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Analyzing with OpenCV...</span>
                                </div>
                                <div id="ai-result" class="d-none">
                                    <p class="mb-1"><strong>Water Level:</strong> <span id="ai-water-level"
                                            class="text-primary fw-bold">--</span></p>
                                    <p class="mb-1"><strong>Confidence:</strong> <span id="ai-confidence">--</span></p>
                                    <p class="mb-0"><strong>Status:</strong> <span id="ai-status">--</span></p>
                                    <p id="ai-reason" class="text-muted small mt-1 mb-0"></p>
                                </div>
                            </div>
                        </div>

                        <div id="manual-input-container" class="mb-3">
                            <label for="water_level" class="form-label">Water Level (meters)</label>
                            <input type="number" step="0.01" class="form-control" id="water_level" name="water_level"
                                required>
                            <div class="form-text">Enter the reading visible on the gauge. Verify the AI reading.</div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-success" id="submit-btn" disabled>
                                <i class="bi bi-check-circle"></i> Submit Reading
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Verification Method Display -->
                <div id="verification-method-display" class="alert alert-info" style="display: none;">
                    <strong>Verification Method:</strong> <span id="method-text">GPS</span>
                </div>

                <!-- Debug Information -->
                <div class="mt-4" id="debug-info" style="display: none;">
                    <h6>Debug Information:</h6>
                    <pre id="debug-content" class="bg-light p-2 small"></pre>
                </div>
            </div>
        </div>
    </div>
    <!-- Gauge Scan Modal -->
    <div class="modal fade" id="gaugeScanModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-robot"></i> AI Gauge Scanner</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <small>Point camera at the water gauge. Ensure numbers are clearly visible.</small>
                    </div>

                    <div id="gauge-camera-container" class="mb-3 position-relative">
                        <video id="gauge-video" width="100%" height="400"
                            style="background: black; border-radius: 8px; object-fit: cover;"></video>
                        <canvas id="gauge-canvas" style="display: none;"></canvas>

                        <!-- Captured Image Preview (hidden initially) -->
                        <img id="gauge-captured-image" class="d-none" width="100%"
                            style="border-radius: 8px; object-fit: cover; max-height: 400px;"
                            alt="Captured gauge image">

                        <!-- Scanning Overlay -->
                        <div id="gauge-overlay"
                            class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center pointer-events-none"
                            style="border: 2px solid rgba(0,255,0,0.5); border-radius: 8px;">
                            <div class="text-white bg-dark bg-opacity-50 px-3 py-1 rounded">
                                Align Gauge Here
                            </div>
                        </div>
                    </div>

                    <div id="gauge-loading" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analyzing with OpenCV...</p>
                    </div>

                    <div id="gauge-result" class="d-none">
                        <!-- Results injected here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="retake-gauge-btn" class="btn btn-outline-warning d-none">
                        <i class="bi bi-arrow-counterclockwise"></i> Retake Photo
                    </button>
                    <button type="button" id="capture-gauge-btn" class="btn btn-primary">
                        <i class="bi bi-camera"></i> Capture & Analyze
                    </button>
                    <button type="button" id="use-gauge-value-btn" class="btn btn-success d-none">
                        <i class="bi bi-check-lg"></i> Use This Reading
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- QR Code Scanner Library -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>



<!-- Fallback CDN for QR Scanner -->
<script>
    if (typeof Html5Qrcode === 'undefined') {
        console.log('Primary QR CDN failed, loading fallback...');
        document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"><\/script>');
    }
</script>

<script>
    let stream = null;
    let gaugeStream = null;
    let capturedPhoto = null;
    let currentCamera = 'environment';
    let qrScanner = null;
    let locationVerified = false;
    let verificationMethod = 'gps';

    // Debug function
    function debugLog(message) {
        console.log(message);
        const debugDiv = document.getElementById('debug-info');
        const debugContent = document.getElementById('debug-content');
        if (debugDiv && debugContent) {
            debugDiv.style.display = 'block';
            debugContent.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }
    }

    // Check if QR scanner is available
    function isQRScannerAvailable() {
        return typeof Html5Qrcode !== 'undefined' && window.Html5Qrcode;
    }

    // Camera functions (existing)
    function showCameraError(message) {
        const errorDiv = document.getElementById('camera-error');
        const errorMessage = document.getElementById('error-message');
        errorMessage.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('video').style.display = 'none';
    }

    function hideCameraError() {
        document.getElementById('camera-error').style.display = 'none';
    }

    function stopCameraStream() {
        if (stream) {
            debugLog('Stopping camera stream');
            stream.getTracks().forEach(track => {
                track.stop();
            });
            stream = null;
        }
    }

    async function initCamera(facingMode = 'environment') {
        try {
            debugLog('Initializing camera with facingMode: ' + facingMode);
            stopCameraStream();

            const constraints = {
                video: {
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            stream = await navigator.mediaDevices.getUserMedia(constraints);
            const video = document.getElementById('video');

            video.srcObject = stream;
            video.style.display = 'block';
            hideCameraError();

            await new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    video.play();
                    resolve();
                };
            });

            debugLog('Camera initialized successfully');
            currentCamera = facingMode;

            document.getElementById('capture-btn').style.display = 'block';
            document.getElementById('switch-camera-btn').style.display = 'block';
            document.getElementById('start-camera-btn').style.display = 'none';

        } catch (err) {
            debugLog('Camera error: ' + err.message);

            if (facingMode === 'environment') {
                showCameraError('Back camera not available. Trying front camera...');
                setTimeout(() => initCamera('user'), 1000);
            } else {
                showCameraError('Cannot access camera: ' + err.message +
                    '. Please ensure camera permissions are granted and try again.');
            }
        }
    }

    function switchCamera() {
        const newMode = currentCamera === 'environment' ? 'user' : 'environment';
        debugLog('Switching camera to: ' + newMode);
        initCamera(newMode);
    }

    function capturePhoto() {
        debugLog('Capturing photo...');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        capturedPhoto = canvas.toDataURL('image/jpeg', 0.8);
        debugLog('Photo captured, size: ' + capturedPhoto.length + ' bytes');

        document.getElementById('preview-img').src = capturedPhoto;
        document.getElementById('photo-preview').style.display = 'block';
        document.getElementById('capture-btn').style.display = 'none';
        document.getElementById('retake-btn').style.display = 'block';
        document.getElementById('switch-camera-btn').style.display = 'none';

        stopCameraStream();
        document.getElementById('video').style.display = 'none';

        // Trigger AI analysis removed - strictly for site proof now

        const waterLevel = document.getElementById('water_level').value;
        if (waterLevel && locationVerified) {
            document.getElementById('submit-btn').disabled = false;
        }
    }

    function retakePhoto() {
        debugLog('Retaking photo...');
        capturedPhoto = null;
        document.getElementById('photo-preview').style.display = 'none';
        document.getElementById('capture-btn').style.display = 'block';
        document.getElementById('retake-btn').style.display = 'none';
        document.getElementById('switch-camera-btn').style.display = 'block';
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('ai-analysis-card').classList.add('d-none'); // Hide AI card on retake
        document.getElementById('ai-analysis-card').classList.add('d-none'); // Hide AI card on retake
        initCamera(currentCamera);
    }

    // AI Analysis Function
    async function analyzeCapturedPhoto(photoDataUrl) {
        const aiAnalysisCard = document.getElementById('ai-analysis-card');
        const aiLoading = document.getElementById('ai-loading');
        const aiResult = document.getElementById('ai-result');
        const waterLevelInput = document.getElementById('water_level');
        const manualInputContainer = document.getElementById('manual-input-container');

        aiAnalysisCard.classList.remove('d-none');
        aiLoading.classList.remove('d-none');
        aiResult.classList.add('d-none');
        document.getElementById('ai-water-level').textContent = '--';
        document.getElementById('ai-confidence').textContent = '--';
        document.getElementById('ai-status').textContent = '--';
        document.getElementById('ai-reason').textContent = '';

        try {
            debugLog('Sending photo for AI analysis...');
            const response = await fetch('/api/analyze-gauge', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image_data: photoDataUrl })
            });

            const data = await response.json();
            debugLog('AI analysis response: ' + JSON.stringify(data));

            aiLoading.classList.add('d-none');
            aiResult.classList.remove('d-none');
            manualInputContainer.classList.remove('d-none'); // Reveal input after analysis attempt

            if (data.success) {
                document.getElementById('ai-status').innerHTML = '<span class="text-success">Analysis successful</span>';
                document.getElementById('ai-reason').textContent = data.message || '';

                if (data.water_level !== null) {
                    document.getElementById('ai-water-level').textContent = `${data.water_level} m`;
                    document.getElementById('ai-confidence').textContent = `${(data.confidence * 100).toFixed(1)}%`;

                    // Auto-fill and highlight
                    waterLevelInput.value = data.water_level;
                    waterLevelInput.classList.add('is-valid');
                    setTimeout(() => waterLevelInput.classList.remove('is-valid'), 2000);
                } else {
                    document.getElementById('ai-water-level').textContent = 'Not detected';
                    document.getElementById('ai-confidence').textContent = 'N/A';
                    document.getElementById('ai-status').innerHTML = '<span class="text-warning">No water level detected</span>';
                    document.getElementById('ai-reason').textContent = data.message || 'Please enter manually.';
                }
            } else {
                document.getElementById('ai-status').innerHTML = '<span class="text-danger">Analysis failed</span>';
                document.getElementById('ai-reason').textContent = data.error || 'An error occurred during analysis. Please enter manually.';
                document.getElementById('ai-water-level').textContent = 'Error';
                document.getElementById('ai-confidence').textContent = 'N/A';
            }

            // Check if submit button can be enabled
            if (waterLevelInput.value && capturedPhoto && locationVerified) {
                document.getElementById('submit-btn').disabled = false;
            }

        } catch (error) {
            console.error('Error analyzing image:', error);
            aiLoading.classList.add('d-none');
            aiResult.classList.remove('d-none');
            document.getElementById('ai-status').innerHTML = '<span class="text-danger">Analysis failed</span>';
            document.getElementById('ai-reason').textContent = 'Network error or server issue. Please enter manually.';
            document.getElementById('ai-water-level').textContent = 'Error';
            document.getElementById('ai-confidence').textContent = 'N/A';
            manualInputContainer.classList.remove('d-none'); // Reveal input on error so user can still submit
        }
    }

    // QR Code Scanner Functions (existing)
    async function startQRScanner() {
        try {
            if (!isQRScannerAvailable()) {
                throw new Error('QR Scanner library not loaded. Please check your internet connection.');
            }

            document.getElementById('scan-qr-btn').style.display = 'none';
            document.getElementById('qr-scanner').style.display = 'block';
            document.getElementById('qr-result').style.display = 'none';
            document.getElementById('manual-qr-entry').style.display = 'none';

            qrScanner = new Html5Qrcode("qr-reader");

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_QR_CODE]
            };

            await qrScanner.start(
                { facingMode: "environment" },
                config,
                onQRScanSuccess,
                onQRScanFailure
            );

            debugLog('QR scanner started successfully');

        } catch (err) {
            debugLog('QR Scanner error: ' + err.message);
            showQRResult('QR scanner not available: ' + err.message, 'warning');
            document.getElementById('manual-qr-entry').style.display = 'block';
            document.getElementById('scan-qr-btn').style.display = 'block';
            document.getElementById('qr-scanner').style.display = 'none';
        }
    }

    function stopQRScanner() {
        if (qrScanner) {
            qrScanner.stop().then(() => {
                qrScanner = null;
                debugLog('QR scanner stopped');
            }).catch(err => {
                console.error('Error stopping QR scanner:', err);
            });
        }

        document.getElementById('scan-qr-btn').style.display = 'block';
        document.getElementById('qr-scanner').style.display = 'none';
    }

    async function onQRScanSuccess(decodedText) {
        debugLog('QR Code scanned: ' + decodedText);
        stopQRScanner();
        await verifyQRCode(decodedText);
    }

    function onQRScanFailure(error) {
        // Silent failure during scanning
    }

    // Manual QR code verification
    async function verifyManualQRCode() {
        const manualInput = document.getElementById('manual-qr-input').value.trim();
        if (!manualInput) {
            showQRResult('Please enter a QR code', 'danger');
            return;
        }

        await verifyQRCode(manualInput);
    }

    async function verifyQRCode(qrData) {
        try {
            const response = await fetch('/api/verify-qr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    site_id: document.querySelector('input[name="site_id"]').value,
                    qr_data: qrData
                })
            });

            const data = await response.json();
            debugLog('QR verification response: ' + JSON.stringify(data));

            if (data.verified) {
                showQRResult('✓ QR Code verified! Location validated successfully.', 'success');

                verificationMethod = 'qr';
                document.getElementById('verification_method').value = 'qr';
                document.getElementById('qr_code_scanned').value = qrData;

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        document.getElementById('latitude').value = position.coords.latitude;
                        document.getElementById('longitude').value = position.coords.longitude;
                        document.getElementById('user-coords').textContent =
                            `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;

                        enableCameraAndInput();
                    }, () => {
                        document.getElementById('latitude').value = data.site_lat;
                        document.getElementById('longitude').value = data.site_lon;
                        document.getElementById('user-coords').textContent =
                            `${data.site_lat.toFixed(6)}, ${data.site_lon.toFixed(6)} (Site coordinates)`;

                        enableCameraAndInput();
                    });
                } else {
                    document.getElementById('latitude').value = data.site_lat;
                    document.getElementById('longitude').value = data.site_lon;
                    document.getElementById('user-coords').textContent =
                        `${data.site_lat.toFixed(6)}, ${data.site_lon.toFixed(6)} (Site coordinates)`;

                    enableCameraAndInput();
                }

            } else {
                showQRResult('✗ Invalid QR code for this site. Please scan the correct QR code.', 'danger');
            }

        } catch (error) {
            debugLog('QR verification error: ' + error.message);
            showQRResult('Error verifying QR code: ' + error.message, 'danger');
        }
    }

    function showQRResult(message, type) {
        const resultDiv = document.getElementById('qr-result');
        resultDiv.textContent = message;
        resultDiv.className = `alert alert-${type}`;
        resultDiv.style.display = 'block';
    }

    function enableCameraAndInput() {
        locationVerified = true;
        document.getElementById('start-camera-btn').disabled = false;

        const methodDisplay = document.getElementById('verification-method-display');
        const methodText = document.getElementById('method-text');
        methodText.textContent = verificationMethod.toUpperCase();
        methodDisplay.style.display = 'block';

        updateLocationStatus('Location verified via ' + verificationMethod.toUpperCase() + '! You can now capture photos.', true);
    }

    // Location functions (existing)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function getLocation() {
        debugLog('Getting location...');
        if (!navigator.geolocation) {
            updateLocationStatus('Geolocation is not supported by this browser. Please use QR code validation.', false);
            return;
        }

        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                debugLog('Location obtained: ' + lat + ', ' + lon);

                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lon;
                document.getElementById('user-coords').textContent = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;

                try {
                    const siteId = document.querySelector('input[name="site_id"]').value;
                    debugLog('Verifying location with server for site: ' + siteId);

                    const response = await fetch('/api/verify-location', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            site_id: siteId,
                            latitude: lat,
                            longitude: lon
                        })
                    });

                    const data = await response.json();
                    debugLog('Server response: ' + JSON.stringify(data));

                    const distance = calculateDistance(lat, lon, data.site_lat, data.site_lon);
                    document.getElementById('distance-info').textContent =
                        `Distance from site: ${distance.toFixed(1)} meters`;

                    if (data.verified) {
                        locationVerified = true;
                        verificationMethod = 'gps';
                        document.getElementById('verification_method').value = 'gps';

                        document.getElementById('start-camera-btn').disabled = false;

                        const methodDisplay = document.getElementById('verification-method-display');
                        const methodText = document.getElementById('method-text');
                        methodText.textContent = 'GPS';
                        methodDisplay.style.display = 'block';

                        updateLocationStatus('Location verified! You can now capture photos.', true);
                    } else {
                        updateLocationStatus('You are outside the permitted zone. Please move closer to the monitoring site or use QR code validation.', false);
                        document.getElementById('start-camera-btn').disabled = true;
                    }

                } catch (error) {
                    debugLog('Error verifying location: ' + error.message);
                    updateLocationStatus('Error verifying location. Please try QR code validation.', false);
                }
            },
            (error) => {
                debugLog('Location error: ' + error.message);
                let message = 'Error getting your location. ';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        message += 'Location access was denied. Please enable location services or use QR code validation.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message += 'Location information is unavailable. Please use QR code validation.';
                        break;
                    case error.TIMEOUT:
                        message += 'Location request timed out. Please use QR code validation.';
                        break;
                    default:
                        message += 'An unknown error occurred. Please use QR code validation.';
                        break;
                }
                updateLocationStatus(message, false);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

    function updateLocationStatus(message, isSuccess) {
        const statusDiv = document.getElementById('location-status');
        statusDiv.innerHTML = isSuccess ?
            `<span class="text-success">✓ ${message}</span>` :
            `<span class="text-danger">✗ ${message}</span>`;
        statusDiv.className = `alert alert-${isSuccess ? 'success' : 'danger'}`;
    }

    // Form submission
    document.getElementById('reading-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        debugLog('Form submission started...');

        if (!capturedPhoto) {
            alert('Please capture a photo before submitting.');
            return;
        }

        if (!locationVerified) {
            alert('Please verify your location using GPS or QR code before submitting.');
            return;
        }

        const waterLevel = document.getElementById('water_level').value;
        if (!waterLevel) {
            alert('Please enter water level.');
            return;
        }

        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Submitting...';

        try {
            debugLog('Converting photo to blob...');

            // Robust DataURL to Blob conversion
            const dataURLtoBlob = (dataurl) => {
                const arr = dataurl.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], { type: mime });
            };

            const blob = dataURLtoBlob(capturedPhoto);
            debugLog('Blob created, size: ' + blob.size + ' bytes');

            const formData = new FormData();
            formData.append('site_id', document.querySelector('input[name="site_id"]').value);
            formData.append('water_level', waterLevel);
            formData.append('latitude', document.getElementById('latitude').value);
            formData.append('longitude', document.getElementById('longitude').value);
            formData.append('verification_method', document.getElementById('verification_method').value);
            formData.append('qr_code_scanned', document.getElementById('qr_code_scanned').value);
            formData.append('photo', blob, 'photo.jpg');

            debugLog('Sending form data to server...');
            const submitResponse = await fetch('/api/submit-reading', {
                method: 'POST',
                body: formData
            });

            debugLog('Server response status: ' + submitResponse.status);
            const result = await submitResponse.json();
            debugLog('Server response: ' + JSON.stringify(result));

            if (result.success) {
                alert('Reading submitted successfully!');
                window.location.href = '/dashboard';
            } else {
                throw new Error(result.error || 'Submission failed');
            }

        } catch (error) {
            debugLog('Submission error: ' + error.message);
            alert('Error submitting reading: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Reading';
        }
    });

    // Enable submit button when water level is entered and photo is captured
    document.getElementById('water_level').addEventListener('input', function () {
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = !(this.value && capturedPhoto && locationVerified);
    });

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function () {
        // Camera event listeners
        document.getElementById('start-camera-btn').addEventListener('click', function () {
            initCamera('environment');
        });

        document.getElementById('capture-btn').addEventListener('click', capturePhoto);
        document.getElementById('retake-btn').addEventListener('click', retakePhoto);
        document.getElementById('switch-camera-btn').addEventListener('click', switchCamera);

        // QR scanner event listeners
        document.getElementById('scan-qr-btn').addEventListener('click', startQRScanner);
        document.getElementById('stop-qr-btn').addEventListener('click', stopQRScanner);
        document.getElementById('submit-manual-qr').addEventListener('click', verifyManualQRCode);

        // --- GAUGE SCANNER LOGIC ---
        let gaugeStream = null;
        const gaugeModal = new bootstrap.Modal(document.getElementById('gaugeScanModal'));

        document.getElementById('scan-gauge-btn').addEventListener('click', function () {
            gaugeModal.show();
            startGaugeCamera();
        });

        document.getElementById('gaugeScanModal').addEventListener('hidden.bs.modal', function () {
            stopGaugeCamera();
            resetGaugeModal();
        });

        async function startGaugeCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                gaugeStream = stream;
                const video = document.getElementById('gauge-video');
                video.srcObject = stream;
                video.play();
            } catch (err) {
                console.error("Error accessing gauge camera:", err);
                alert("Could not access camera for gauge scanning.");
            }
        }

        function stopGaugeCamera() {
            if (gaugeStream) {
                gaugeStream.getTracks().forEach(track => track.stop());
                gaugeStream = null;
            }
        }

        document.getElementById('capture-gauge-btn').addEventListener('click', async function () {
            const video = document.getElementById('gauge-video');
            const canvas = document.getElementById('gauge-canvas');
            const capturedImage = document.getElementById('gauge-captured-image');
            const overlay = document.getElementById('gauge-overlay');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageDataUrl = canvas.toDataURL('image/jpeg');

            // Show captured image, hide video and overlay
            video.classList.add('d-none');
            overlay.classList.add('d-none');
            capturedImage.src = imageDataUrl;
            capturedImage.classList.remove('d-none');

            // Show loading state
            document.getElementById('gauge-loading').classList.remove('d-none');
            document.getElementById('gauge-result').classList.add('d-none');
            document.getElementById('capture-gauge-btn').disabled = true;

            try {
                const response = await fetch('/api/analyze-gauge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_data: imageDataUrl })
                });

                const data = await response.json();

                document.getElementById('gauge-loading').classList.add('d-none');
                document.getElementById('gauge-result').classList.remove('d-none');
                // Show retake button, hide capture button
                document.getElementById('capture-gauge-btn').classList.add('d-none');
                document.getElementById('retake-gauge-btn').classList.remove('d-none');

                const resultDiv = document.getElementById('gauge-result');

                if (data.success && data.water_level !== null) {
                    // Determine pipeline badge
                    let pipelineBadge = '';
                    let conditionBadges = '';

                    if (data.method === 'gemini') {
                        pipelineBadge = '<span class="badge bg-success me-1"><i class="bi bi-cpu"></i> OpenCV</span>';
                    } else {
                        pipelineBadge = '<span class="badge bg-success me-1"><i class="bi bi-cpu"></i> OpenCV</span>';
                    }

                    // Show detected conditions
                    if (data.conditions) {
                        if (data.conditions.is_night) {
                            conditionBadges += '<span class="badge bg-dark me-1"><i class="bi bi-moon-fill"></i> Night</span>';
                        }
                        if (data.conditions.is_rainy) {
                            conditionBadges += '<span class="badge bg-primary me-1"><i class="bi bi-cloud-rain"></i> Rain/Blur</span>';
                        }
                        if (data.conditions.is_far) {
                            conditionBadges += '<span class="badge bg-secondary me-1"><i class="bi bi-binoculars"></i> Far</span>';
                        }
                    }

                    // Processing time
                    const processingTime = data.processing_time_ms ? `<small class="text-muted">(${data.processing_time_ms}ms)</small>` : '';

                    // Voice fallback warning
                    let voiceWarning = '';
                    if (data.requires_voice_fallback) {
                        voiceWarning = '<div class="alert alert-warning mt-2 mb-0 py-1 px-2"><small><i class="bi bi-mic"></i> Low confidence - consider voice + photo fallback</small></div>';
                    }

                    // Tamper detection warning
                    let tamperWarning = '';
                    if (data.tamper_detected) {
                        tamperWarning = `<div class="alert alert-danger mt-2 mb-0 py-2 px-3">
                            <strong><i class="bi bi-shield-exclamation"></i> Tamper Detected!</strong>
                            <p class="mb-0 small">${data.tamper_reason || 'This image appears to have been altered or manipulated.'}</p>
                        </div>`;
                    }

                    // Suggestions for better images
                    let suggestionsHtml = '';
                    if (data.suggestions && data.suggestions.length > 0) {
                        suggestionsHtml = `<div class="alert alert-info mt-2 mb-0 py-2 px-3">
                            <strong><i class="bi bi-lightbulb"></i> Tips for better reading:</strong>
                            <ul class="mb-0 ps-3 mt-1 small">
                                ${data.suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>`;
                    }

                    // Image quality badge
                    let qualityBadge = '';
                    const quality = data.image_quality || 'unknown';
                    const qualityColors = {
                        'excellent': 'success',
                        'good': 'info',
                        'fair': 'warning',
                        'poor': 'danger',
                        'unusable': 'dark',
                        'unknown': 'secondary'
                    };
                    qualityBadge = `<span class="badge bg-${qualityColors[quality] || 'secondary'} ms-1">${quality}</span>`;

                    // Gauge location info
                    let gaugeInfo = '';
                    if (data.gauge_location || data.water_line_position) {
                        gaugeInfo = `<div class="small text-muted mt-2 border-top pt-2">
                            ${data.gauge_location ? `<div><i class="bi bi-geo-alt"></i> <strong>Gauge:</strong> ${data.gauge_location}</div>` : ''}
                            ${data.water_line_position ? `<div><i class="bi bi-water"></i> <strong>Water line:</strong> ${data.water_line_position}</div>` : ''}
                        </div>`;
                    }

                    resultDiv.innerHTML = `
                        <div class="alert ${data.tamper_detected ? 'alert-warning' : 'alert-success'}">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0"><i class="bi bi-check-circle"></i> Reading Detected!</h6>
                                <div>${pipelineBadge}${qualityBadge}${processingTime}</div>
                            </div>
                            ${conditionBadges ? '<div class="mb-2">' + conditionBadges + '</div>' : ''}
                            <div class="display-4 text-center my-2">${data.water_level} m</div>
                            <small class="d-block text-center text-muted">Confidence: ${(data.confidence * 100).toFixed(0)}%</small>
                            ${gaugeInfo}
                            <p class="mb-0 mt-2 small">${data.message || data.reason || ''}</p>
                            ${tamperWarning}
                            ${voiceWarning}
                            ${suggestionsHtml}
                        </div>
                    `;

                    // Auto-fill the manual input
                    document.getElementById('water_level').value = data.water_level;

                    // Trigger input event to enable submit button if other conditions met
                    document.getElementById('water_level').dispatchEvent(new Event('input'));

                    const useBtn = document.getElementById('use-gauge-value-btn');
                    useBtn.classList.remove('d-none');
                    useBtn.onclick = function () {
                        gaugeModal.hide();
                    };
                } else {
                    // Error/failure display with pipeline info
                    let pipelineBadge = '';
                    if (data.method) {
                        pipelineBadge = '<span class="badge bg-success"><i class="bi bi-cpu"></i> OpenCV</span> ';
                    }

                    // Tamper warning for errors too
                    let tamperWarningError = '';
                    if (data.tamper_detected) {
                        tamperWarningError = `<div class="alert alert-danger mt-2 mb-0 py-2 px-3">
                            <strong><i class="bi bi-shield-exclamation"></i> Image Tampering Detected!</strong>
                            <p class="mb-1 small">${data.tamper_reason || 'This image appears to have been altered or manipulated.'}</p>
                            <small class="text-muted">Please take a fresh, unedited photo of the gauge.</small>
                        </div>`;
                    }

                    // Scene validation warning (gauge not in water, etc.)
                    let sceneWarning = '';
                    if (data.scene_valid === false) {
                        sceneWarning = `<div class="alert alert-danger mt-2 mb-0 py-2 px-3">
                            <strong><i class="bi bi-geo-alt-fill"></i> Invalid Scene Detected!</strong>
                            <p class="mb-1 small">${data.scene_issue || 'The image does not show a valid water level gauge in a river/water body.'}</p>
                            <small class="text-muted">The gauge must be physically installed in and partially submerged in water.</small>
                        </div>`;
                    }

                    // No gauge detected warning
                    let noGaugeWarning = '';
                    if (data.no_gauge_detected) {
                        noGaugeWarning = `<div class="alert alert-warning mt-2 mb-0 py-2 px-3">
                            <strong><i class="bi bi-search"></i> No Gauge Found!</strong>
                            <p class="mb-0 small">No water level gauge/staff was detected in this image. Please point the camera at the measuring gauge.</p>
                        </div>`;
                    }

                    // Suggestions for failure case
                    let failSuggestions = '';
                    if (data.suggestions && data.suggestions.length > 0) {
                        failSuggestions = `<div class="alert alert-info mt-2 mb-0 py-2 px-3">
                            <strong><i class="bi bi-lightbulb"></i> How to get a better reading:</strong>
                            <ul class="mb-0 ps-3 mt-1 small">
                                ${data.suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>`;
                    } else {
                        // Default suggestions if none provided
                        failSuggestions = `<div class="alert alert-info mt-2 mb-0 py-2 px-3">
                            <strong><i class="bi bi-lightbulb"></i> Tips for a clear reading:</strong>
                            <ul class="mb-0 ps-3 mt-1 small">
                                <li>Move closer to the gauge for clearer numbers</li>
                                <li>Ensure good lighting on the gauge</li>
                                <li>Hold camera steady to avoid blur</li>
                                <li>Take photo straight-on, not at an angle</li>
                            </ul>
                        </div>`;
                    }

                    // Determine error type for styling
                    let alertClass = 'alert-warning';
                    let errorTitle = 'Could not read gauge';
                    if (data.tamper_detected) {
                        alertClass = 'alert-danger';
                        errorTitle = 'Cannot Accept Image';
                    } else if (data.scene_valid === false) {
                        alertClass = 'alert-danger';
                        errorTitle = 'Invalid Scene';
                    } else if (data.no_gauge_detected) {
                        alertClass = 'alert-warning';
                        errorTitle = 'No Gauge Found';
                    }

                    resultDiv.innerHTML = `
                        <div class="alert ${alertClass}">
                            <h6><i class="bi bi-exclamation-triangle"></i> ${errorTitle} ${pipelineBadge}</h6>
                            <p class="mb-0">${data.reason || data.message || data.error || 'Unable to detect water level from this image.'}</p>
                            ${data.requires_voice_fallback ? '<div class="mt-2"><small><i class="bi bi-mic"></i> Consider using voice + photo fallback</small></div>' : ''}
                        </div>
                        ${sceneWarning}
                        ${noGaugeWarning}
                        ${tamperWarningError}
                        ${failSuggestions}
                    `;
                }

            } catch (error) {
                console.error("Gauge analysis error:", error);
                document.getElementById('gauge-loading').classList.add('d-none');
                document.getElementById('gauge-result').classList.remove('d-none');
                document.getElementById('gauge-result').innerHTML = `<div class="alert alert-danger">Error analyzing image. Please try again.</div>`;
                document.getElementById('capture-gauge-btn').disabled = false;
            }
        });

        function resetGaugeModal() {
            document.getElementById('gauge-loading').classList.add('d-none');
            document.getElementById('gauge-result').classList.add('d-none');
            document.getElementById('use-gauge-value-btn').classList.add('d-none');
            document.getElementById('capture-gauge-btn').disabled = false;
            // Reset video/image display
            document.getElementById('gauge-video').classList.remove('d-none');
            document.getElementById('gauge-overlay').classList.remove('d-none');
            document.getElementById('gauge-captured-image').classList.add('d-none');
            // Reset buttons
            document.getElementById('capture-gauge-btn').classList.remove('d-none');
            document.getElementById('retake-gauge-btn').classList.add('d-none');
        }

        // Retake photo button handler
        document.getElementById('retake-gauge-btn').addEventListener('click', function () {
            resetGaugeModal();
        });

        // Allow Enter key in manual QR input
        document.getElementById('manual-qr-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                verifyManualQRCode();
            }
        });

        // Initialize page
        debugLog('Page loaded, initializing...');
        getLocation();

        // Refresh location every 10 seconds
        setInterval(getLocation, 10000);
    });

    // Clean up when leaving page
    window.addEventListener('beforeunload', function () {
        stopCameraStream();
        stopQRScanner();
        if (gaugeStream) {
            gaugeStream.getTracks().forEach(track => track.stop());
        }
    });
</script>

<style>
    #qr-reader {
        position: relative;
    }

    #qr-reader video {
        width: 100% !important;
        height: 300px !important;
        border-radius: 8px;
    }

    #qr-reader div:first-child {
        border: none !important;
    }

    .btn {
        border-radius: 6px;
    }

    .alert {
        border-radius: 8px;
    }

    .card {
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .form-control {
        border-radius: 6px;
    }

    #manual-qr-entry {
        border-left: 4px solid #ffc107;
        padding-left: 15px;
    }

    #gauge-scan-video,
    #video {
        border-radius: 8px;
    }
</style>
{% endblock %}