{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2>Tamper Detection & Security</h2>
                <p class="lead mb-0">Monitor and analyze submission integrity</p>
            </div>
            <div>
                <select id="dateRange" class="form-select form-select-sm d-inline-block me-2" style="width: auto;"
                    onchange="changeDateRange()">
                    <option value="7">Last 7 days</option>
                    <option value="14">Last 14 days</option>
                    <option value="30" selected>Last 30 days</option>
                    <option value="90">Last 90 days</option>
                </select>
                <div class="btn-group">
                    <button class="btn btn-primary btn-sm" onclick="runBatchAnalysis()">
                        <i class="bi bi-arrow-repeat"></i> Run Analysis
                    </button>
                    <button class="btn btn-danger btn-sm disabled">
                        <i class="bi bi-shield-lock-fill"></i> Security Active
                    </button>
                </div>
            </div>
        </div>

        <!-- Security Alert Banner (Moved here to prevent gaps) -->
        <div id="securityAlert" class="alert alert-danger alert-dismissible fade show d-none mb-4">
            <div class="d-flex align-items-center">
                <i class="bi bi-shield-exclamation me-2 fs-4"></i>
                <div id="securityAlertMessage"></div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>

<!-- Overview Cards -->
<!-- Overview Cards -->
<div class="row g-3">
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card bg-primary bg-opacity-10 bg-gradient border border-primary border-opacity-25 shadow-sm h-100">
            <div class="card-body">
                <div class="text-center">
                    <h3 class="card-title fw-bold text-primary" id="totalDetections">0</h3>
                    <p class="card-text small text-uppercase fw-bold text-primary opacity-75">Total</p>
                    <i class="bi bi-exclamation-triangle display-6 mt-2 text-primary opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card bg-warning bg-opacity-10 bg-gradient border border-warning border-opacity-25 shadow-sm h-100">
            <div class="card-body">
                <div class="text-center">
                    <h3 class="card-title fw-bold text-dark" id="pendingReview">0</h3>
                    <p class="card-text small text-uppercase fw-bold text-dark opacity-75">Pending</p>
                    <i class="bi bi-clock display-6 mt-2 text-warning opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card bg-danger bg-opacity-10 bg-gradient border border-danger border-opacity-25 shadow-sm h-100">
            <div class="card-body">
                <div class="text-center">
                    <h3 class="card-title fw-bold text-danger" id="confirmedTamper">0</h3>
                    <p class="card-text small text-uppercase fw-bold text-danger opacity-75">Tampered</p>
                    <i class="bi bi-shield-x display-6 mt-2 text-danger opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card bg-info bg-opacity-10 bg-gradient border border-info border-opacity-25 shadow-sm h-100">
            <div class="card-body">
                <div class="text-center">
                    <h3 class="card-title fw-bold text-dark" id="suspiciousSubmissions">0</h3>
                    <p class="card-text small text-uppercase fw-bold text-dark opacity-75">Suspicious</p>
                    <i class="bi bi-search display-6 mt-2 text-info opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div class="card bg-success bg-opacity-10 bg-gradient border border-success border-opacity-25 shadow-sm h-100">
            <div class="card-body">
                <div class="text-center">
                    <h3 class="card-title fw-bold text-success" id="cleanSubmissions">0</h3>
                    <p class="card-text small text-uppercase fw-bold text-success opacity-75">Clean</p>
                    <i class="bi bi-shield-check display-6 mt-2 text-success opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-6">
        <div
            class="card bg-secondary bg-opacity-10 bg-gradient border border-secondary border-opacity-25 shadow-sm h-100">
            <div class="card-body">
                <div class="text-center">
                    <h3 class="card-title fw-bold text-dark" id="avgTamperScore">0.0</h3>
                    <p class="card-text small text-uppercase fw-bold text-dark opacity-75">Avg Score</p>
                    <i class="bi bi-graph-up display-6 mt-2 text-secondary opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trend Charts Row -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-graph-up me-2"></i>Detection Trends</h5>
            </div>
            <div class="card-body">
                <div id="trendChart" style="height: 250px;">
                    <div class="text-center py-5">
                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                        <p class="mt-2 text-muted small">Loading trend data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-speedometer2 me-2"></i>Tamper Score Timeline</h5>
            </div>
            <div class="card-body">
                <div id="scoreChart" style="height: 250px;">
                    <div class="text-center py-5">
                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                        <p class="mt-2 text-muted small">Loading score data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Distribution Charts Row -->
<div class="row mb-4">
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-pie-chart me-2"></i>By Detection Type</h5>
            </div>
            <div class="card-body">
                <div id="typeChart" style="height: 200px;">
                    <div class="text-center py-5">
                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-bar-chart me-2"></i>By Severity Level</h5>
            </div>
            <div class="card-body">
                <div id="severityChart" style="height: 200px;">
                    <div class="text-center py-5">
                        <div class="spinner-border spinner-border-sm text-secondary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-lightning-fill me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body d-flex align-items-center">
                <div class="d-grid gap-3 w-100">
                    <button class="btn btn-outline-primary" onclick="runBatchAnalysis()">
                        <i class="bi bi-arrow-repeat me-2"></i>Analyze Recent Data
                    </button>
                    <button class="btn btn-outline-secondary" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Refresh Dashboard
                    </button>
                    <button class="btn btn-outline-danger" onclick="exportSecurityReport()">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Export Security Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column - Recent Detections -->
    <div class="col-lg-8">
        <!-- Recent Tamper Detections -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="bi bi-activity me-2"></i>Recent Tamper Detections</h5>
                <button class="btn btn-sm btn-link text-decoration-none" onclick="viewAllDetections()">View All</button>
            </div>
            <div class="card-body p-0">
                <div id="recentDetections" class="list-group list-group-flush"
                    style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center py-5">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                        <p class="mt-2 text-muted small">Loading tamper detections...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Suspicious Submissions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-exclamation-octagon me-2"></i>High-Risk Submissions</h5>
            </div>
            <div class="card-body p-0">
                <div id="suspiciousSubmissionsList" class="list-group list-group-flush"
                    style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center py-5">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                        <p class="mt-2 text-muted small">Loading suspicious submissions...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column - Security Actions -->
    <div class="col-lg-4">
        <!-- Detection Types (moved here for balance) -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-pie-chart me-2"></i>Detection Breakdown</h5>
            </div>
            <div class="card-body">
                <div id="detectionTypesChart" style="height: 250px;">
                    <div class="text-center py-5">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status">
                            <span class="visually-hidden">Loading chart...</span>
                        </div>
                        <p class="mt-2 text-muted small">Loading detection types...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Alerts List (New Feature Placeholder) -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-people-fill me-2"></i>Agent Risk Monitor</h5>
            </div>
            <div class="card-body p-0">
                <div id="agentAlertsList" class="list-group list-group-flush">
                    <div class="text-center py-4">
                        <p class="text-muted mb-0 small">No active agent alerts</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title">Review Tamper Detection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
        </div>
        <div class="modal-body">
            <div id="reviewDetectionContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
        <div class="modal-footer bg-light">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="confirmTamper()">Confirm Tamper</button>
            <button type="button" class="btn btn-outline-danger" onclick="markFalsePositive()">False Positive</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global variables
    let currentDetectionId = null;
    let currentDays = 30;
    // ... [Previous JS variables remain same]
    let trendChart = null;
    let scoreChart = null;
    let typeChart = null;
    let severityChart = null;

    // Initialize tamper detection dashboard
    async function initializeTamperDashboard() {
        await loadOverviewStats();
        await loadTrendCharts();
        await loadRecentDetections();
        await loadSuspiciousSubmissions();
        await loadAgentAlerts();
    }

    // Change date range
    function changeDateRange() {
        currentDays = parseInt(document.getElementById('dateRange').value);
        loadTrendCharts();
    }

    // Refresh all data
    function refreshData() {
        showToast('Refreshing dashboard...', 'info');
        initializeTamperDashboard();
    }

    // Load trend charts
    async function loadTrendCharts() {
        try {
            const response = await fetch(`/api/tamper-detection/trends?days=${currentDays}`);
            const data = await response.json();

            // Detection Trends Chart
            const trendCtx = document.createElement('canvas');
            document.getElementById('trendChart').innerHTML = '';
            document.getElementById('trendChart').appendChild(trendCtx);

            if (trendChart) trendChart.destroy();
            trendChart = new Chart(trendCtx, {
                type: 'bar',
                data: {
                    labels: data.trends.labels,
                    datasets: [{
                        label: 'Detections',
                        data: data.trends.detections,
                        backgroundColor: 'rgba(255, 193, 7, 0.6)', // Warning Yellow (Softer)
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { display: true, drawBorder: false, color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { size: 11 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });

            // Tamper Score Timeline
            const scoreCtx = document.createElement('canvas');
            document.getElementById('scoreChart').innerHTML = '';
            document.getElementById('scoreChart').appendChild(scoreCtx);

            if (scoreChart) scoreChart.destroy();
            scoreChart = new Chart(scoreCtx, {
                type: 'line',
                data: {
                    labels: data.scores.labels,
                    datasets: [{
                        label: 'Avg Score',
                        data: data.scores.avg_scores,
                        borderColor: 'rgba(220, 53, 69, 1)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2
                    }, {
                        label: 'Max Score',
                        data: data.scores.max_scores,
                        borderColor: 'rgba(255, 193, 7, 1)', // Warning Yellow
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true } } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            grid: { display: true, drawBorder: false, color: 'rgba(0,0,0,0.05)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // By Type Chart
            const typeCtx = document.createElement('canvas');
            document.getElementById('typeChart').innerHTML = '';
            document.getElementById('typeChart').appendChild(typeCtx);

            if (typeChart) typeChart.destroy();
            typeChart = new Chart(typeCtx, {
                type: 'doughnut',
                data: {
                    labels: data.by_type.labels.length > 0 ? data.by_type.labels : ['No Data'],
                    datasets: [{
                        data: data.by_type.data.length > 0 ? data.by_type.data : [1],
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'], // Soft Semantic Colors
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { display: false } }
                }
            });

            // By Severity Chart
            const severityCtx = document.createElement('canvas');
            document.getElementById('severityChart').innerHTML = '';
            document.getElementById('severityChart').appendChild(severityCtx);

            if (severityChart) severityChart.destroy();
            severityChart = new Chart(severityCtx, {
                type: 'bar',
                data: {
                    labels: data.by_severity.labels.length > 0 ? data.by_severity.labels : ['No Data'],
                    datasets: [{
                        label: 'Count',
                        data: data.by_severity.data.length > 0 ? data.by_severity.data : [0],
                        backgroundColor: ['#17a2b8', '#ffc107', '#dc3545', '#343a40'], // Semantic Severity
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: true, color: 'rgba(0,0,0,0.05)' } },
                        y: { grid: { display: false } }
                    }
                }
            });

        } catch (error) {
            console.error('Error loading trend charts:', error);
            document.getElementById('trendChart').innerHTML = '<div class="alert alert-warning">No trend data available</div>';
        }
    }

    // Load overview statistics
    async function loadOverviewStats() {
        try {
            const response = await fetch('/api/tamper-detection/overview');
            const data = await response.json();

            if (data.error) {
                console.error('API Error:', data.error);
                return;
            }

            // Update statistics cards with real data
            document.getElementById('totalDetections').textContent = data.statistics.total_detections || 0;
            document.getElementById('pendingReview').textContent = data.statistics.pending_review || 0;
            document.getElementById('confirmedTamper').textContent = data.statistics.confirmed_tamper || 0;
            document.getElementById('suspiciousSubmissions').textContent = data.statistics.suspicious_submissions || 0;
            document.getElementById('cleanSubmissions').textContent = data.statistics.clean_submissions || 0;
            document.getElementById('avgTamperScore').textContent = data.statistics.avg_tamper_score || '0.00';

        } catch (error) {
            console.error('Error loading overview stats:', error);
        }
    }

    // Load recent tamper detections
    async function loadRecentDetections() {
        try {
            const response = await fetch('/api/tamper-detection/overview');
            const data = await response.json();

            const container = document.getElementById('recentDetections');

            if (!data.recent_detections || data.recent_detections.length === 0) {
                container.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-check-circle text-success display-6 mb-2 opacity-50"></i>
                    <p class="text-muted mb-0">No tamper detections found</p>
                </div>
            `;
                return;
            }

            let html = '';
            data.recent_detections.forEach(detection => {
                const severityClass = getSeverityClass(detection.severity);
                const timeAgo = getTimeAgo(detection.detected_at);

                html += `
                <div class="list-group-item list-group-item-action border-bottom px-3 py-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge ${severityClass} me-2 text-uppercase" style="font-size: 0.7rem;">${detection.severity}</span>
                                <span class="badge bg-light text-dark border me-2">${detection.detection_type}</span>
                                <small class="text-muted" style="font-size: 0.75rem;">${timeAgo}</small>
                            </div>
                            <p class="mb-1 fw-bold text-dark small">${detection.description}</p>
                            <small class="text-muted d-block">
                                <i class="bi bi-geo-alt me-1"></i>${detection.site_name} 
                                <span class="mx-1">•</span>
                                <i class="bi bi-person me-1"></i>${detection.agent_name}
                            </small>
                            <div class="mt-1">
                                <small class="text-primary fw-bold">Confidence: ${(detection.confidence_score * 100).toFixed(0)}%</small>
                            </div>
                        </div>
                        <div class="dropdown ms-2">
                            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item small" href="#" onclick="reviewDetection(${detection.id})"><i class="bi bi-check2-circle me-2"></i>Review</a></li>
                                <li><a class="dropdown-item small" href="/submissions?submission_id=${detection.submission_id}"><i class="bi bi-eye me-2"></i>View Submission</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            });

            container.innerHTML = html;
            // Also update the detection types chart if needed here, but separate call is cleaner
            loadDetectionTypesChart(data);


        } catch (error) {
            console.error('Error loading recent detections:', error);
        }
    }

    // Load suspicious submissions
    async function loadSuspiciousSubmissions() {
        try {
            const response = await fetch('/api/tamper-detection/overview');
            const data = await response.json();

            const container = document.getElementById('suspiciousSubmissionsList');

            if (!data.suspicious_submissions || data.suspicious_submissions.length === 0) {
                container.innerHTML = `
                <div class="text-center py-4">
                    <p class="text-muted mb-0">No suspicious submissions</p>
                </div>
            `;
                return;
            }

            let html = '';
            data.suspicious_submissions.forEach(submission => {
                const tamperClass = submission.tamper_score > 0.8 ? 'danger' : 'warning';
                const timeAgo = getTimeAgo(submission.timestamp);

                html += `
                <div class="list-group-item list-group-item-action border-bottom px-3 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 text-dark fs-6 font-monospace">${submission.site_name}</h6>
                            <p class="mb-1 small text-muted"><i class="bi bi-water me-1"></i>Level: ${submission.water_level}m</p>
                            <small class="text-muted" style="font-size: 0.75rem;">${timeAgo} • ${submission.user_name}</small>
                        </div>
                        <div class="text-end ms-3">
                            <span class="badge bg-light text-${tamperClass} border border-${tamperClass} mb-1">Score: ${submission.tamper_score.toFixed(2)}</span>
                            <br>
                            <small class="text-muted fw-bold" style="font-size: 0.7rem;">${submission.tamper_status}</small>
                        </div>
                    </div>
                </div>
            `;
            });

            container.innerHTML = html;

        } catch (error) {
            console.error('Error loading suspicious submissions:', error);
        }
    }

    // Load agent alerts
    async function loadAgentAlerts() {
        try {
            const response = await fetch('/api/tamper-detection/overview');
            const data = await response.json();

            const container = document.getElementById('agentAlertsList');

            if (!data.agent_alerts || data.agent_alerts.length === 0) {
                container.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-shield-check text-success fs-4 mb-2 opacity-50"></i>
                    <p class="text-muted mb-0 small">No agent alerts</p>
                </div>
            `;
                return;
            }

            let html = '';
            data.agent_alerts.forEach(alert => {
                const statusClass = alert.status === 'critical' ? 'danger' : 'warning';

                html += `
                <div class="list-group-item border-bottom px-3 py-3">
                    <div class="d-flex align-items-start">
                        <div class="rounded-circle bg-${statusClass} bg-opacity-10 p-2 me-3">
                             <i class="bi bi-exclamation-triangle-fill text-${statusClass}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-bold">${alert.agent_name}</h6>
                            <p class="mb-1 small text-danger fw-bold">Suspicious ratio: ${(alert.suspicious_ratio * 100).toFixed(1)}%</p>
                            <small class="text-muted d-block">${alert.total_submissions} total submissions</small>
                        </div>
                    </div>
                </div>
            `;
            });

            container.innerHTML = html;

        } catch (error) {
            console.error('Error loading agent alerts:', error);
        }
    }

    // Load detection types chart (Updated to take data or fetch)
    async function loadDetectionTypesChart(preloadedData) {
        try {
            let data = preloadedData;
            if (!data) {
                const response = await fetch('/api/tamper-detection/overview');
                data = await response.json();
            }

            // Count detection types from recent detections
            const typeCounts = {};
            if (data.recent_detections) {
                data.recent_detections.forEach(detection => {
                    typeCounts[detection.detection_type] = (typeCounts[detection.detection_type] || 0) + 1;
                });
            }

            const ctx = document.createElement('canvas');
            document.getElementById('detectionTypesChart').innerHTML = '';
            document.getElementById('detectionTypesChart').appendChild(ctx);

            const chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeCounts),
                    datasets: [{
                        data: Object.values(typeCounts),
                        backgroundColor: [
                            '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'
                        ],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 10,
                                usePointStyle: true,
                                padding: 15,
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });

        } catch (error) {
            console.error('Error loading detection types chart:', error);
        }
    }

    // Utility functions
    function getSeverityClass(severity) {
        const classes = {
            'low': 'bg-info bg-opacity-25 text-dark',
            'medium': 'bg-warning bg-opacity-25 text-dark',
            'high': 'bg-danger bg-opacity-25 text-dark',
            'critical': 'bg-dark text-white'
        };
        return classes[severity] || 'bg-secondary';
    }

    function getTimeAgo(timestamp) {
        if (!timestamp) return 'Unknown';

        const now = new Date();
        const time = new Date(timestamp);
        const diffMs = now - time;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        return `${Math.floor(diffHours / 24)}d ago`;
    }

    // Action functions
    async function runBatchAnalysis() {
        try {
            const response = await fetch('/api/tamper-detection/run-batch-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ days: 30 })
            });

            const result = await response.json();

            if (result.success) {
                showToast('Batch analysis completed successfully', 'success');
                initializeTamperDashboard(); // Refresh data
            } else {
                showToast('Analysis failed: ' + result.error, 'danger');
            }

        } catch (error) {
            showToast('Analysis request failed', 'danger');
        }
    }

    function reviewDetection(detectionId) {
        currentDetectionId = detectionId;

        // For now, just show a simple review interface
        const modalContent = document.getElementById('reviewDetectionContent');
        modalContent.innerHTML = `
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>Reviewing Detection #${detectionId}
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold">Review Notes</label>
            <textarea class="form-control" id="reviewNotes" rows="3" placeholder="Add detailed notes about your review decision..."></textarea>
        </div>
    `;

        const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
        modal.show();
    }

    async function confirmTamper() {
        if (!currentDetectionId) return;

        try {
            const response = await fetch(`/api/tamper-detection/detections/${currentDetectionId}/review`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    review_status: 'confirmed',
                    review_notes: document.getElementById('reviewNotes').value
                })
            });

            const result = await response.json();

            if (result.success) {
                showToast('Tamper confirmed', 'success');
                bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
                initializeTamperDashboard(); // Refresh data
            } else {
                showToast('Review failed: ' + result.error, 'danger');
            }

        } catch (error) {
            showToast('Review request failed', 'danger');
        }
    }

    async function markFalsePositive() {
        if (!currentDetectionId) return;

        try {
            const response = await fetch(`/api/tamper-detection/detections/${currentDetectionId}/review`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    review_status: 'false_positive',
                    review_notes: document.getElementById('reviewNotes').value
                })
            });

            const result = await response.json();

            if (result.success) {
                showToast('Marked as false positive', 'success');
                bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
                initializeTamperDashboard(); // Refresh data
            } else {
                showToast('Review failed: ' + result.error, 'danger');
            }

        } catch (error) {
            showToast('Review request failed', 'danger');
        }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initializeTamperDashboard);
</script>

<style>
    /* Dashboard Theme Overrides */
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;
    }

    .ls-1 {
        letter-spacing: 1px;
    }

    .list-group-item {
        transition: background-color 0.2s ease;
    }

    .list-group-item:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    /* Scrollbar styling for lists */
    .list-group-flush::-webkit-scrollbar {
        width: 6px;
    }

    .list-group-flush::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .list-group-flush::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    .list-group-flush::-webkit-scrollbar-thumb:hover {
        background: #bbb;
    }
</style>
{% endblock %}