<!-- React & Babel CDNs -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<!-- Tailwind is already loaded in base.html via CDN if not, ensure it's there. Assuming base.html has it or style.css covers it. 
     Task requested Tailwind, so I'll add the CDN here to be safe if not present, but usually better in head. 
     User's base.html showed bootstrap but not tailwind. I will explicitly add tailwind logic if needed or just use inline styles mimicking tailwind 
     if adding full tailwind css conflicts with bootstrap. 
     Actually, mixing Bootstrap and Tailwind can be messy. 
     I'll use a scoped approach or just raw CSS classes that look like Tailwind if conflict arises. 
     But request said "Write a React/Tailwind chat widget". I will assume I can load Tailwind. -->
<script src="https://cdn.tailwindcss.com"></script>

<div id="crisis-chat-root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CrisisChatWidget = () => {
        const [isOpen, setIsOpen] = useState(false);
        const [messages, setMessages] = useState([
            { id: 1, text: "Hello. I am the Flood Safety Expert. How can I assist you with crisis preparation or evacuation today?", sender: 'bot' }
        ]);
        const [inputText, setInputText] = useState("");
        const [isLoading, setIsLoading] = useState(false);
        const messagesEndRef = useRef(null);

        const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        };

        useEffect(() => {
            scrollToBottom();
        }, [messages, isOpen]);

        const handleSendMessage = async (e) => {
            e.preventDefault();
            if (!inputText.trim()) return;

            const userMsg = { id: Date.now(), text: inputText, sender: 'user' };
            setMessages(prev => [...prev, userMsg]);
            setInputText("");
            setIsLoading(true);

            try {
                const response = await fetch('/api/crisis-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: userMsg.text })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const botMsg = {
                    id: Date.now() + 1,
                    text: data.response,
                    sender: 'bot'
                };
                setMessages(prev => [...prev, botMsg]);
            } catch (error) {
                const errorMsg = {
                    id: Date.now() + 1,
                    text: "I apologize, but I am currently unable to connect. Please contact local emergency services if you are in immediate danger.",
                    sender: 'bot'
                };
                setMessages(prev => [...prev, errorMsg]);
            } finally {
                setIsLoading(false);
            }
        };

        const clearChat = () => {
            setMessages([
                { id: 1, text: "Chat history cleared. How can I help?", sender: 'bot' }
            ]);
        };

        // Styling constants (Tailwind classes)
        const bubbleClass = "fixed bottom-6 left-6 w-14 h-14 bg-red-600 hover:bg-red-700 text-white rounded-full flex items-center justify-center shadow-lg cursor-pointer transition-all z-50 animate-bounce-slow";
        const windowClass = "fixed bottom-6 left-6 w-80 md:w-96 bg-white rounded-lg shadow-2xl flex flex-col overflow-hidden z-50 border border-gray-200 font-sans";
        const headerClass = "bg-red-600 text-white p-4 flex justify-between items-center";
        const bodyClass = "flex-1 p-4 overflow-y-auto h-96 bg-gray-50";
        const footerClass = "p-3 border-t bg-white flex gap-2";

        if (!isOpen) {
            return (
                <div className={bubbleClass} onClick={() => setIsOpen(true)}>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                    </svg>
                </div>
            );
        }

        return (
            <div className={windowClass} style={{ maxHeight: 'calc(100vh - 100px)' }}>
                {/* Header */}
                <div className={headerClass}>
                    <div className="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                        <h3 className="font-bold text-sm">Crisis Assistant</h3>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={clearChat} className="p-1 hover:bg-red-500 rounded text-xs" title="Clear Chat">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                            </svg>
                        </button>
                        <button onClick={() => setIsOpen(false)} className="p-1 hover:bg-red-500 rounded" title="Close">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                    </div>
                </div>

                {/* Body */}
                <div className={bodyClass}>
                    {messages.map((msg) => (
                        <div key={msg.id} className={`mb-3 flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                            <div className={`max-w-[85%] p-3 rounded-lg text-sm ${msg.sender === 'user'
                                    ? 'bg-red-100 text-red-900 rounded-br-none'
                                    : 'bg-white border border-gray-200 text-gray-800 rounded-bl-none shadow-sm markdown-body'
                                }`}>
                                <div style={{ whiteSpace: 'pre-wrap' }}>{msg.text}</div>
                            </div>
                        </div>
                    ))}
                    {isLoading && (
                        <div className="mb-3 flex justify-start">
                            <div className="bg-gray-100 p-3 rounded-lg rounded-bl-none">
                                <div className="flex space-x-1">
                                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.2s' }}></div>
                                    <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0.4s' }}></div>
                                </div>
                            </div>
                        </div>
                    )}
                    <div ref={messagesEndRef} />
                </div>

                {/* Footer */}
                <form onSubmit={handleSendMessage} className={footerClass}>
                    <input
                        type="text"
                        value={inputText}
                        onChange={(e) => setInputText(e.target.value)}
                        placeholder="Ask about flood safety..."
                        className="flex-1 border rounded px-3 py-2 text-sm focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500"
                        disabled={isLoading}
                    />
                    <button
                        type="submit"
                        disabled={isLoading || !inputText.trim()}
                        className="bg-red-600 text-white p-2 rounded hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                        </svg>
                    </button>
                </form>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('crisis-chat-root'));
    root.render(<CrisisChatWidget />);
</script>

<!-- Add a slow bounce animation for the bubble -->
<style>
    @keyframes bounce-slow {

        0%,
        100% {
            transform: translateY(-5%);
        }

        50% {
            transform: translateY(5%);
        }
    }

    .animate-bounce-slow {
        animation: bounce-slow 3s infinite ease-in-out;
    }
</style>